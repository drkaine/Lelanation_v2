// Lelanation stats: matches and participants (Ranked Solo/Duo, EUW/EUNE)
// See epic-lol-statistics-platform.md

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Niveau match: champs légers, teams en Json compact (bans + objectives) pour éviter tables séparées.
model Match {
  id               BigInt   @id @default(autoincrement())
  matchId          String   @unique @map("match_id")
  region           String   // euw1, eun1
  queueId          Int      @map("queue_id") // 420 = Ranked Solo/Duo
  gameVersion      String?  @map("game_version")
  gameDuration     Int?     @map("game_duration")
  platformId       String?  @map("platform_id")
  endOfGameResult  String?  @map("end_of_game_result") // GameComplete, Remake, etc. — filtre matchs valides
  rank             String?  // average rank of players in the match, e.g. "GOLD_II"
  teams            Json?    // [{ bans: [{ championId }], objectives: { baron, dragon, tower, ... } }, ...]
  puuidKeyVersion  String?  @map("puuid_key_version") // dev|perso|prod — clé Riot associée aux PUUIDs (évite re-fetch si déjà migré)
  createdAt        DateTime @default(now()) @map("created_at")

  participants Participant[]

  @@index([endOfGameResult])
  @@map("matches")
}

// Participant: colonnes indexées pour agrégations; bans/objectives dans Match.teams.
// riotIdGameName/riotIdTagline du payload → remplissent Player.summoner_name à la collecte (pas stockés ici).
model Participant {
  id                          BigInt   @id @default(autoincrement())
  matchId                     BigInt   @map("match_id")
  teamId                      Int?     @map("team_id") // 100 = blue, 200 = red (Riot convention)
  puuid                       String
  championId                  Int      @map("champion_id")
  win                         Boolean
  role                        String?  // TOP, JUNGLE, MIDDLE, BOTTOM, UTILITY (dérivé teamPosition/individualPosition)
  rankTier                    String?  @map("rank_tier")
  rankDivision                String?  @map("rank_division")
  rankLp                      Int?     @map("rank_lp")
  kills                       Int      @default(0)
  deaths                      Int      @default(0)
  assists                     Int      @default(0)
  champLevel                  Int?     @map("champ_level")
  goldEarned                  Int?     @map("gold_earned")
  totalDamageDealtToChampions Int?     @map("total_damage_dealt_to_champions")
  totalMinionsKilled          Int?     @map("total_minions_killed")
  visionScore                 Int?     @map("vision_score")
  firstBloodKill              Boolean? @map("first_blood_kill")
  firstBloodAssist            Boolean? @map("first_blood_assist")
  firstTowerAssist            Boolean? @map("first_tower_assist")
  firstTowerKill              Boolean? @map("first_tower_kill")
  gameEndedInSurrender        Boolean? @map("game_ended_in_surrender")
  gameEndedInEarlySurrender   Boolean? @map("game_ended_in_early_surrender")
  teamEarlySurrendered        Boolean? @map("team_early_surrendered")
  baronKills                  Int?     @map("baron_kills")
  consumablesPurchased       Int?     @map("consumables_purchased")
  damageDealtToBuildings      Int?     @map("damage_dealt_to_buildings")
  damageDealtToEpicMonsters   Int?     @map("damage_dealt_to_epic_monsters")
  damageDealtToObjectives     Int?     @map("damage_dealt_to_objectives")
  damageDealtToTurrets        Int?     @map("damage_dealt_to_turrets")
  damageSelfMitigated         Int?     @map("damage_self_mitigated")
  doubleKills                 Int?     @map("double_kills")
  dragonKills                 Int?     @map("dragon_kills")
  goldSpent                   Int?     @map("gold_spent")
  inhibitorKills             Int?     @map("inhibitor_kills")
  inhibitorTakedowns         Int?     @map("inhibitor_takedowns")
  inhibitorsLost             Int?     @map("inhibitors_lost")
  itemsPurchased              Int?     @map("items_purchased")
  killingSprees               Int?     @map("killing_sprees")
  largestCriticalStrike       Int?     @map("largest_critical_strike")
  largestKillingSpree         Int?     @map("largest_killing_spree")
  largestMultiKill            Int?     @map("largest_multi_kill")
  longestTimeSpentLiving      Int?     @map("longest_time_spent_living")
  magicDamageDealt            Int?     @map("magic_damage_dealt")
  magicDamageDealtToChampions Int?     @map("magic_damage_dealt_to_champions")
  magicDamageTaken            Int?     @map("magic_damage_taken")
  neutralMinionsKilled        Int?     @map("neutral_minions_killed")
  objectivesStolen            Int?     @map("objectives_stolen")
  objectivesStolenAssists     Int?     @map("objectives_stolen_assists")
  pentaKills                  Int?     @map("penta_kills")
  physicalDamageDealt         Int?     @map("physical_damage_dealt")
  physicalDamageDealtToChampions Int?  @map("physical_damage_dealt_to_champions")
  physicalDamageTaken        Int?     @map("physical_damage_taken")
  placement                   Int?     @map("placement")
  quadraKills                 Int?     @map("quadra_kills")
  roleBoundItem               Int?     @map("role_bound_item")
  sightWardsBoughtInGame     Int?     @map("sight_wards_bought_in_game")
  timeCCingOthers             Int?     @map("time_ccing_others")
  totalAllyJungleMinionsKilled Int?   @map("total_ally_jungle_minions_killed")
  totalDamageDealt            Int?     @map("total_damage_dealt")
  totalDamageShieldedOnTeammates Int?   @map("total_damage_shielded_on_teammates")
  totalDamageTaken            Int?     @map("total_damage_taken")
  totalEnemyJungleMinionsKilled Int?   @map("total_enemy_jungle_minions_killed")
  totalHeal                   Int?     @map("total_heal")
  totalHealsOnTeammates       Int?     @map("total_heals_on_teammates")
  totalTimeCCDealt            Int?     @map("total_time_cc_dealt")
  totalTimeSpentDead          Int?     @map("total_time_spent_dead")
  totalUnitsHealed            Int?     @map("total_units_healed")
  tripleKills                 Int?     @map("triple_kills")
  trueDamageDealt             Int?     @map("true_damage_dealt")
  trueDamageDealtToChampions  Int?     @map("true_damage_dealt_to_champions")
  trueDamageTaken             Int?     @map("true_damage_taken")
  turretKills                 Int?     @map("turret_kills")
  turretTakedowns             Int?     @map("turret_takedowns")
  turretsLost                 Int?     @map("turrets_lost")
  unrealKills                 Int?     @map("unreal_kills")
  visionWardsBoughtInGame     Int?     @map("vision_wards_bought_in_game")
  wardsKilled                 Int?     @map("wards_killed")
  wardsPlaced                 Int?     @map("wards_placed")
  spell1Casts                 Int?     @map("spell1_casts")
  spell2Casts                 Int?     @map("spell2_casts")
  spell3Casts                 Int?     @map("spell3_casts")
  spell4Casts                 Int?     @map("spell4_casts")
  summoner1Casts              Int?     @map("summoner1_casts")
  summoner2Casts              Int?     @map("summoner2_casts")
  statPerks                   Json?    @map("stat_perks") // { defense, flex, offense } — champs dédié (api-riot perks.statPerks)
  items                       Json?    // [item_id, ...]
  runes                       Json?    // perks.styles (runes détaillées)
  summonerSpells              Json?    @map("summoner_spells") // [summoner1Id, summoner2Id]
  challenges                  Json?    // optionnel; null si pas utilisé
  createdAt                   DateTime @default(now()) @map("created_at")

  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([matchId])
  @@index([puuid])
  @@index([championId])
  @@index([rankTier])
  @@index([role])
  @@index([championId, rankTier])
  @@index([gameEndedInSurrender])
  @@map("participants")
}

model Player {
  puuid           String    @id
  summonerName    String?   @map("summoner_name")
  region          String
  puuidKeyVersion String?   @map("puuid_key_version") // dev|perso|prod — clé Riot utilisée pour ce PUUID
  lastSeen        DateTime? @map("last_seen")
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([region])
  @@index([puuidKeyVersion])
  @@index([lastSeen])
  @@map("players")
}

// Aggregated champion-vs-champion matchup score for tier-listing.
model MatchupTierScore {
  id                 BigInt   @id @default(autoincrement())
  patch              String
  lane               String
  championId         Int      @map("champion_id")
  opponentChampionId Int      @map("opponent_champion_id")
  rankFilterKey      String   @default("GLOBAL") @map("rank_filter_key")
  games              Int      @default(0)
  wins               Int      @default(0)
  sumKda             Float    @default(0) @map("sum_kda")
  sumLevel           Float    @default(0) @map("sum_level")
  avgKda             Float    @default(0) @map("avg_kda")
  avgLevel           Float    @default(0) @map("avg_level")
  score              Int      @default(0)
  confidence         Float    @default(0)
  prevPatchScore     Int?     @map("prev_patch_score")
  deltaVsPrevPatch   Int?     @map("delta_vs_prev_patch")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@unique([patch, lane, championId, opponentChampionId, rankFilterKey], map: "matchup_tier_scores_unique")
  @@index([patch, lane, rankFilterKey, score], map: "matchup_tier_scores_patch_lane_rank_idx")
  @@index([championId, patch, rankFilterKey], map: "matchup_tier_scores_champ_patch_rank_idx")
  @@map("matchup_tier_scores")
}

